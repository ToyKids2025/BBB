/**
 * üî• SERVICE WORKER - PUSH NOTIFICATIONS REMARKETING FOMO
 * Sistema de notifica√ß√µes push para recuperar vendas perdidas
 */

// Configura√ß√µes
const NOTIFICATION_DEFAULTS = {
  badge: '/icon-72.png',
  icon: '/icon-192.png',
  vibrate: [200, 100, 200],
  requireInteraction: true,
  renotify: true,
  tag: 'remarketing-fomo'
};

/**
 * INSTALA√á√ÉO - Configurar Service Worker
 */
self.addEventListener('install', (event) => {
  console.log('üî• Push Service Worker instalado');
  self.skipWaiting();
});

/**
 * ATIVA√á√ÉO - Limpar cache antigo
 */
self.addEventListener('activate', (event) => {
  console.log('‚úÖ Push Service Worker ativado');
  event.waitUntil(clients.claim());
});

/**
 * PUSH EVENT - Receber notifica√ß√£o push
 */
self.addEventListener('push', (event) => {
  console.log('üì® Push notification recebida:', event);

  let data = {};

  try {
    if (event.data) {
      data = event.data.json();
    }
  } catch (error) {
    console.error('Erro ao parsear dados push:', error);
    data = {
      title: 'üî• Oferta Especial!',
      body: 'Voc√™ tem uma nova oferta dispon√≠vel',
      type: 'default'
    };
  }

  // Gerar notifica√ß√£o baseada no tipo
  const notification = generateFOMONotification(data);

  event.waitUntil(
    self.registration.showNotification(notification.title, notification.options)
  );
});

/**
 * GERAR NOTIFICA√á√ÉO FOMO
 */
function generateFOMONotification(data) {
  const templates = {
    // ESCASSEZ - 6 horas
    scarcity: {
      title: 'üî• Quase Esgotado!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `S√≥ ${data.stock || '5'} unidades do ${data.product || 'produto'} restantes!`,
        image: data.image,
        data: { url: data.url, type: 'scarcity', clickId: data.clickId },
        actions: [
          { action: 'buy', title: 'üõí Comprar Agora', icon: '/icon-cart.png' },
          { action: 'later', title: 'Depois', icon: '/icon-clock.png' }
        ],
        badge: '/badge-fire.png'
      }
    },

    // PROVA SOCIAL - 12 horas
    social_proof: {
      title: 'üë• Muito Procurado!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `${data.buyers || '31'} pessoas compraram ${data.product || 'este produto'} hoje!`,
        image: data.image,
        data: { url: data.url, type: 'social_proof', clickId: data.clickId },
        actions: [
          { action: 'view', title: 'üëÅÔ∏è Ver Produto', icon: '/icon-eye.png' },
          { action: 'dismiss', title: '‚ùå Ignorar', icon: '/icon-x.png' }
        ],
        badge: '/badge-trending.png'
      }
    },

    // DESCONTO - 20 horas
    discount: {
      title: 'üí∞ Desconto Exclusivo!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `R$ ${data.discount || '50'} OFF no ${data.product || 'produto'} - S√≥ hoje!`,
        image: data.image,
        data: { url: data.url, type: 'discount', clickId: data.clickId },
        actions: [
          { action: 'claim', title: 'üí∞ Resgatar', icon: '/icon-money.png' },
          { action: 'later', title: '‚è∞ Depois', icon: '/icon-clock.png' }
        ],
        vibrate: [100, 200, 100, 200, 100],
        badge: '/badge-sale.png'
      }
    },

    // URG√äNCIA FINAL - 23 horas
    final_warning: {
      title: 'üö® √öLTIMA CHANCE!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `Link expira em ${data.remaining || '1 hora'}! ${data.product || 'Produto'}`,
        image: data.image,
        data: { url: data.url, type: 'final_warning', clickId: data.clickId },
        actions: [
          { action: 'buy_now', title: 'üî• COMPRAR J√Å!', icon: '/icon-urgent.png' }
        ],
        vibrate: [500, 200, 500, 200, 500],
        requireInteraction: true,
        badge: '/badge-alert.png',
        silent: false
      }
    },

    // CARRINHO ABANDONADO
    cart_reminder: {
      title: 'üõí Voc√™ Esqueceu Algo!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `${data.product || 'Item'} ainda est√° no seu carrinho`,
        image: data.image,
        data: { url: data.url, type: 'cart_reminder', clickId: data.clickId },
        actions: [
          { action: 'checkout', title: '‚úÖ Finalizar', icon: '/icon-check.png' },
          { action: 'remove', title: 'üóëÔ∏è Remover', icon: '/icon-trash.png' }
        ],
        badge: '/badge-cart.png'
      }
    },

    // PRICE DROP
    price_drop: {
      title: 'üìâ Pre√ßo Caiu!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `${data.product || 'Produto'} agora R$ ${data.newPrice || '199,90'}!`,
        image: data.image,
        data: { url: data.url, type: 'price_drop', clickId: data.clickId },
        actions: [
          { action: 'buy', title: 'üí∞ Aproveitar', icon: '/icon-money.png' },
          { action: 'track', title: 'üìä Acompanhar', icon: '/icon-chart.png' }
        ],
        badge: '/badge-discount.png'
      }
    },

    // BACK IN STOCK
    back_in_stock: {
      title: '‚úÖ Voltou ao Estoque!',
      options: {
        ...NOTIFICATION_DEFAULTS,
        body: `${data.product || 'Produto'} dispon√≠vel novamente!`,
        image: data.image,
        data: { url: data.url, type: 'back_in_stock', clickId: data.clickId },
        actions: [
          { action: 'buy', title: 'üõí Comprar', icon: '/icon-cart.png' },
          { action: 'save', title: '‚ù§Ô∏è Salvar', icon: '/icon-heart.png' }
        ],
        badge: '/badge-check.png'
      }
    }
  };

  // Selecionar template baseado no tipo ou usar padr√£o
  const template = templates[data.type] || templates.scarcity;

  // Adicionar timestamp
  if (template.options.body) {
    const now = new Date().toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
    template.options.body += ` ‚Ä¢ ${now}`;
  }

  return template;
}

/**
 * NOTIFICATION CLICK - Quando usu√°rio clica na notifica√ß√£o
 */
self.addEventListener('notificationclick', (event) => {
  console.log('üéØ Notifica√ß√£o clicada:', event.action);

  event.notification.close();

  const data = event.notification.data;
  let targetUrl = data?.url || 'https://buscabuscabrasil.com.br';

  // Adicionar tracking parameters
  const trackingParams = new URLSearchParams({
    utm_source: 'push_notification',
    utm_medium: 'remarketing',
    utm_campaign: data?.type || 'fomo',
    click_id: data?.clickId || 'unknown',
    action: event.action || 'click'
  });

  targetUrl += (targetUrl.includes('?') ? '&' : '?') + trackingParams.toString();

  // A√ß√µes espec√≠ficas
  switch (event.action) {
    case 'buy':
    case 'buy_now':
    case 'checkout':
    case 'claim':
      // Convers√£o - abrir direto no produto
      event.waitUntil(
        clients.openWindow(targetUrl).then(() => {
          // Registrar convers√£o
          trackConversion(data.clickId, 'push_notification');
        })
      );
      break;

    case 'view':
    case 'track':
      // Visualiza√ß√£o - abrir em nova aba
      event.waitUntil(clients.openWindow(targetUrl));
      break;

    case 'save':
      // Salvar para depois
      saveForLater(data);
      break;

    case 'later':
      // Adiar - reagendar notifica√ß√£o
      rescheduleNotification(data);
      break;

    case 'dismiss':
    case 'remove':
      // Ignorar/Remover - marcar como n√£o interessado
      markNotInterested(data.clickId);
      break;

    default:
      // Click na notifica√ß√£o sem a√ß√£o espec√≠fica
      event.waitUntil(
        clients.matchAll({ type: 'window' }).then((clientList) => {
          // Se j√° tem aba aberta, focar nela
          for (const client of clientList) {
            if (client.url === targetUrl && 'focus' in client) {
              return client.focus();
            }
          }
          // Sen√£o, abrir nova aba
          if (clients.openWindow) {
            return clients.openWindow(targetUrl);
          }
        })
      );
  }
});

/**
 * NOTIFICATION CLOSE - Quando notifica√ß√£o √© fechada
 */
self.addEventListener('notificationclose', (event) => {
  console.log('‚ùå Notifica√ß√£o fechada');

  const data = event.notification.data;

  // Registrar que foi fechada sem a√ß√£o
  if (data?.clickId) {
    trackEvent('notification_closed', {
      clickId: data.clickId,
      type: data.type
    });
  }
});

/**
 * FUN√á√ïES AUXILIARES
 */

// Rastrear convers√£o
async function trackConversion(clickId, source) {
  try {
    await fetch('/api/conversions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        clickId,
        source,
        timestamp: Date.now()
      })
    });

    console.log('üí∞ Convers√£o registrada:', clickId);
  } catch (error) {
    console.error('Erro ao registrar convers√£o:', error);
  }
}

// Salvar para depois
async function saveForLater(data) {
  try {
    // Salvar no IndexedDB ou localStorage via postMessage
    const allClients = await clients.matchAll();
    allClients.forEach(client => {
      client.postMessage({
        type: 'save_for_later',
        data: data
      });
    });
  } catch (error) {
    console.error('Erro ao salvar:', error);
  }
}

// Reagendar notifica√ß√£o
async function rescheduleNotification(data) {
  try {
    // Reagendar para 6 horas depois
    const delay = 6 * 60 * 60 * 1000;

    setTimeout(() => {
      self.registration.showNotification(
        '‚è∞ Lembrete: Oferta ainda dispon√≠vel!',
        {
          ...NOTIFICATION_DEFAULTS,
          body: `${data.product || 'Produto'} ainda est√° esperando por voc√™`,
          data: data
        }
      );
    }, delay);

    console.log('‚è∞ Notifica√ß√£o reagendada');
  } catch (error) {
    console.error('Erro ao reagendar:', error);
  }
}

// Marcar como n√£o interessado
async function markNotInterested(clickId) {
  try {
    await fetch('/api/not-interested', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clickId })
    });

    console.log('‚ùå Marcado como n√£o interessado:', clickId);
  } catch (error) {
    console.error('Erro ao marcar:', error);
  }
}

// Rastrear evento
async function trackEvent(eventName, data) {
  try {
    await fetch('/api/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event: eventName,
        ...data,
        timestamp: Date.now()
      })
    });
  } catch (error) {
    console.error('Erro ao rastrear evento:', error);
  }
}

/**
 * SINCRONIZA√á√ÉO PERI√ìDICA
 */
self.addEventListener('periodicsync', (event) => {
  if (event.tag === 'check-pending-conversions') {
    event.waitUntil(checkPendingConversions());
  }
});

async function checkPendingConversions() {
  try {
    // Buscar convers√µes pendentes do servidor
    const response = await fetch('/api/pending-conversions');
    const pending = await response.json();

    // Processar cada convers√£o pendente
    for (const item of pending) {
      const timeSinceClick = Date.now() - item.clickTime;
      const schedule = getNotificationSchedule(item.platform);

      // Verificar qual notifica√ß√£o enviar baseado no tempo
      for (const notification of schedule) {
        if (timeSinceClick >= notification.delay &&
            !item.notifications?.includes(notification.type)) {

          // Enviar notifica√ß√£o
          await self.registration.showNotification(
            notification.title,
            {
              ...NOTIFICATION_DEFAULTS,
              ...notification.options,
              data: {
                clickId: item.clickId,
                url: item.url,
                type: notification.type,
                product: item.productName
              }
            }
          );

          // Marcar como enviada
          await markNotificationSent(item.clickId, notification.type);

          break; // Enviar apenas uma notifica√ß√£o por vez
        }
      }
    }
  } catch (error) {
    console.error('Erro ao verificar convers√µes pendentes:', error);
  }
}

// Obter agenda de notifica√ß√µes
function getNotificationSchedule(platform) {
  const schedules = {
    amazon: [
      { delay: 6 * 3600000, type: 'scarcity', title: 'üî• Estoque Baixo!' },
      { delay: 12 * 3600000, type: 'social_proof', title: 'üë• Muito Procurado!' },
      { delay: 20 * 3600000, type: 'discount', title: 'üí∞ Desconto Especial!' },
      { delay: 23 * 3600000, type: 'final_warning', title: 'üö® √öLTIMA CHANCE!' }
    ],
    mercadolivre: [
      { delay: 2 * 3600000, type: 'cart_reminder', title: 'üõí Carrinho Esperando!' },
      { delay: 8 * 3600000, type: 'price_drop', title: 'üìâ Pre√ßo Caiu!' },
      { delay: 16 * 3600000, type: 'scarcity', title: 'üî• √öltimas Unidades!' }
    ]
  };

  return schedules[platform] || schedules.amazon;
}

// Marcar notifica√ß√£o como enviada
async function markNotificationSent(clickId, type) {
  try {
    await fetch('/api/notifications/sent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clickId, type })
    });
  } catch (error) {
    console.error('Erro ao marcar notifica√ß√£o:', error);
  }
}

console.log('üî• Push Service Worker carregado e pronto!');